---
id: cff5c05e-555f-4a60-9611-9c659dc0f8d5
title: Design: Worker Migration to WebSocket Communication
tags: [architecture, websocket, ipc, stability]
files: [electron/backend/ws/server.ts, electron/services/vector/CodeIndexerService.ts, electron/workers/indexing/discovery-worker.js, electron/workers/indexing/parser-worker.js]
createdAt: 2026-01-04T06:28:45.346Z
updatedAt: 2026-01-04T06:28:45.346Z
---

# Worker Migration to WebSocket Design

## Problem
Currently, `CodeIndexerService` uses `worker_threads` with `JSON-RPC` over `postMessage`. While this is standard, Electron/Node.js IPC pipes on Windows are prone to "not connected" native crashes during heavy I/O or rapid worker recycling (as documented in existing KB articles).

## Proposed Solution: The "Local WebSocket" Bridge
Instead of using internal IPC, we will migrate worker communication to the same WebSocket infrastructure used by the Renderer.

### Architecture
1. **Core WS Server**: Use the existing `WebSocketServer` in `electron/backend/ws/server.ts`.
2. **Worker Connection**: Each worker thread will open a `ws` connection to the internal WebSocket server on startup.
3. **Authentication**: Use the same short-lived token generated by `startWsBackend()`.
4. **Multiplexing**: 
   - Workers will use a specific namespace/method prefix (e.g. `worker.*`) or simply connect as a distinct "client type".
   - The main process will identify these connections and handle `worker.request` patterns.

### Advantages
- **Decoupled Lifecycle**: WebSocket sockets are managed by the kernel/network stack, more robust than Electron's internal Pipe handles on Windows.
- **Unified Protocol**: Exactly the same `JSON-RPC` patterns as the Renderer.
- **Standard Tooling**: Easier to debug with network interceptors if needed.

### Implementation Checklist
- [ ] Modify `WsBootstrap` to expose the URL and token globally (or via a service).
- [ ] Create `WorkerWsTransport` helper for the worker side.
- [ ] Update `CodeIndexerService` to pass the WS URL/Token to workers.
- [ ] Update workers to connect via `ws` instead of listening on `parentPort`.
- [ ] Register `worker.*` handlers in `electron/backend/ws/server.ts`.
